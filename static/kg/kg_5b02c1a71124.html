<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Graph: can you tell me about ndcs for brazil</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { margin: 0; padding: 10px; font-family: Arial, sans-serif; }
        .container { width: 100%; height: 1200px; border: 1px solid #ddd; position: relative; }
        .graph { width: 100%; height: 100%; }
        .tooltip { 
            position: absolute; 
            background: rgba(0,0,0,0.8); 
            color: white; 
            padding: 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            pointer-events: none; 
            opacity: 0;
        }
        .query-title { 
            font-size: 14px; 
            font-weight: bold; 
            margin-bottom: 10px; 
            color: #333;
        }
        .node { cursor: pointer; }
        .link { stroke: #999; stroke-opacity: 0.6; stroke-width: 1.5px; }
        .node-label {
            font-size: 10px;
            fill: #333;
            text-anchor: middle;
            pointer-events: none;
            paint-order: stroke;
            stroke: white;
            stroke-width: 3px;
        }
    </style>
</head>
<body>
    <div class="query-title">Knowledge Graph: can you tell me about ndcs for brazil</div>
    <div class="container">
        <svg class="graph" id="kg-graph"></svg>
        <div class="tooltip" id="tooltip"></div>
    </div>
    
    <script>
        // Embedded KG data
        const kgData = {
  "nodes": [
    {
      "id": "nuclear safety standard",
      "type": "Concept",
      "label": "nuclear safety standard",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "drinking water standard",
      "type": "Concept",
      "label": "drinking water standard",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "waste management standard",
      "type": "Concept",
      "label": "waste management standard",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "congestion charge",
      "type": "Concept",
      "label": "congestion charge",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "mitigation technologies",
      "type": "Concept",
      "label": "mitigation technologies",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "Transport technologies",
      "type": "Concept",
      "label": "Transport technologies",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "fees and charges",
      "type": "Concept",
      "label": "fees and charges",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "imbalance charge",
      "type": "Concept",
      "label": "imbalance charge",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "Q1379",
      "type": "Concept",
      "label": "charges",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "regulatory instrument",
      "type": "Concept",
      "label": "regulatory instrument",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "building code and standard",
      "type": "Concept",
      "label": "building code and standard",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "technology standard",
      "type": "Concept",
      "label": "technology standard",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "renewable portfolio standard",
      "type": "Concept",
      "label": "renewable portfolio standard",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "Q265",
      "type": "Concept",
      "label": "Intelligent transport systems",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "emission charge",
      "type": "Concept",
      "label": "emission charge",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "permits and licenses",
      "type": "Concept",
      "label": "permits and licenses",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "Q1651",
      "type": "Concept",
      "label": "target",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "air pollution standard",
      "type": "Concept",
      "label": "air pollution standard",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "emissions reduction target",
      "type": "Concept",
      "label": "emissions reduction target",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "water quality standard",
      "type": "Concept",
      "label": "water quality standard",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "pollution charge",
      "type": "Concept",
      "label": "pollution charge",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "Q1432",
      "type": "Concept",
      "label": "licenses",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "user charge",
      "type": "Concept",
      "label": "user charge",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "Q1281",
      "type": "Concept",
      "label": "codes and standards",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "energy efficiency standard",
      "type": "Concept",
      "label": "energy efficiency standard",
      "importance": 1.0,
      "source_server": "cpr"
    },
    {
      "id": "policy instruments",
      "type": "Concept",
      "label": "policy instruments",
      "importance": 1.0,
      "source_server": "cpr"
    }
  ],
  "links": [
    {
      "source": "Q265",
      "target": "Transport technologies",
      "type": "SUBCONCEPT_OF"
    },
    {
      "source": "Q265",
      "target": "mitigation technologies",
      "type": "SUBCONCEPT_OF"
    },
    {
      "source": "Q1281",
      "target": "regulatory instrument",
      "type": "SUBCONCEPT_OF"
    },
    {
      "source": "Q1281",
      "target": "air pollution standard",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "building code and standard",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "energy efficiency standard",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "renewable portfolio standard",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "technology standard",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "water quality standard",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "drinking water standard",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "waste management standard",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "nuclear safety standard",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1651",
      "target": "policy instruments",
      "type": "SUBCONCEPT_OF"
    },
    {
      "source": "Q1651",
      "target": "emissions reduction target",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1379",
      "target": "fees and charges",
      "type": "SUBCONCEPT_OF"
    },
    {
      "source": "Q1379",
      "target": "pollution charge",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1379",
      "target": "user charge",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1379",
      "target": "congestion charge",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1379",
      "target": "imbalance charge",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1379",
      "target": "emission charge",
      "type": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1432",
      "target": "permits and licenses",
      "type": "SUBCONCEPT_OF"
    }
  ],
  "edges": [
    {
      "source": "Q265",
      "target": "Transport technologies",
      "type": "SUBCONCEPT_OF",
      "label": "SUBCONCEPT_OF"
    },
    {
      "source": "Q265",
      "target": "mitigation technologies",
      "type": "SUBCONCEPT_OF",
      "label": "SUBCONCEPT_OF"
    },
    {
      "source": "Q1281",
      "target": "regulatory instrument",
      "type": "SUBCONCEPT_OF",
      "label": "SUBCONCEPT_OF"
    },
    {
      "source": "Q1281",
      "target": "air pollution standard",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "building code and standard",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "energy efficiency standard",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "renewable portfolio standard",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "technology standard",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "water quality standard",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "drinking water standard",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "waste management standard",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1281",
      "target": "nuclear safety standard",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1651",
      "target": "policy instruments",
      "type": "SUBCONCEPT_OF",
      "label": "SUBCONCEPT_OF"
    },
    {
      "source": "Q1651",
      "target": "emissions reduction target",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1379",
      "target": "fees and charges",
      "type": "SUBCONCEPT_OF",
      "label": "SUBCONCEPT_OF"
    },
    {
      "source": "Q1379",
      "target": "pollution charge",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1379",
      "target": "user charge",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1379",
      "target": "congestion charge",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1379",
      "target": "imbalance charge",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1379",
      "target": "emission charge",
      "type": "HAS_SUBCONCEPT",
      "label": "HAS_SUBCONCEPT"
    },
    {
      "source": "Q1432",
      "target": "permits and licenses",
      "type": "SUBCONCEPT_OF",
      "label": "SUBCONCEPT_OF"
    }
  ],
  "concepts": [],
  "relationships": []
};
        
        // Drawing area
        const width = 1000;   // increased for breathing room
        const height = 1200;  // increased for breathing room
        
        const svg = d3.select("#kg-graph")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", `0 0 ${width} ${height}`);
            
        const g = svg.append("g");
        
        // Data
        const nodes = kgData.nodes || [];
        const links = kgData.links || [];

        // Small initial jitter so nodes don't stack at same start pos
        nodes.forEach(n => {
            if (n.x == null || n.y == null) {
                n.x = (width / 2) + (Math.random() - 0.5) * 50;
                n.y = (height / 2) + (Math.random() - 0.5) * 50;
            }
        });

        // Color mapping
        const nodeColors = {
            'Concept': '#1f77b4',
            'Dataset': '#ff7f0e', 
            'Passage': '#2ca02c',
            'Document': '#d62728',
            'Unknown': '#7f7f7f'
        };

        // Reusable node radius (kept in sync with circle r)
        function nodeRadius(d) {
            return Math.max(5, Math.min(15, (d.importance || 1) * 8));
        }

        // Build degree map for smarter link distances
        const degree = {};
        links.forEach(l => {
            const sid = (typeof l.source === 'object') ? l.source.id : l.source;
            const tid = (typeof l.target === 'object') ? l.target.id : l.target;
            degree[sid] = (degree[sid] || 0) + 1;
            degree[tid] = (degree[tid] || 0) + 1;
        });

        // Create links
        const link = g.append("g")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("class", "link");
        
        // Create nodes
        const node = g.append("g")
            .selectAll("circle")
            .data(nodes)
            .enter().append("circle")
            .attr("class", "node")
            .attr("r", d => nodeRadius(d))
            .attr("fill", d => nodeColors[d.type] || nodeColors['Unknown'])
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));
        
        // Add labels (dy uses node radius to keep text just above the circle)
        const label = g.append("g")
            .selectAll("text")
            .data(nodes)
            .enter().append("text")
            .attr("class", "node-label")
            .attr("dy", d => -(nodeRadius(d) + 3))
            .text(d => d.label || d.id);

        // Zoom (we call svg.call(zoom) AFTER label exists so we can toggle it)
        const zoom = d3.zoom()
            .scaleExtent([0.3, 3])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
                const k = event.transform.k;
                // Hide labels when zoomed far out; show as we zoom in
                label.style("display", k < 0.6 ? "none" : null);
                // Optional: scale label font a bit with zoom for readability
                const baseFont = 10;
                label.attr("font-size", `${Math.max(8, Math.min(16, baseFont * Math.sqrt(k)))}px`);
            });
        
        // Physics simulation with collision + stronger repulsion + degree-aware link distance
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links)
                .id(d => d.id)
                .distance(d => {
                    const sid = d.source.id || d.source, tid = d.target.id || d.target;
                    const sdeg = degree[sid] || 0, tdeg = degree[tid] || 0;
                    return 70 + 12 * Math.max(sdeg, tdeg);
                })
                .strength(0.7)
                )

            // Make charge depend on degree: isolates repel less, hubs repel more
            .force("charge", d3.forceManyBody().strength(d => (degree[d.id] || 0) === 0 ? -120 : -400))
            .force("collide", d3.forceCollide().radius(d => nodeRadius(d) + 6).iterations(2))
            .force("x", d3.forceX(width / 2).strength(0.03))   // gentle pull to center
            .force("y", d3.forceY(height / 2).strength(0.03))  // gentle pull to center
            .force("center", d3.forceCenter(width / 2, height / 2))
            .velocityDecay(0.35)
            .alpha(1)
            .alphaDecay(0.02);

        const isolateRadius = Math.min(width, height) * 0.38;
            simulation.force("isolateRadial", d3.forceRadial(
            isolateRadius,
            width / 2,
            height / 2
            ).strength(d => (degree[d.id] || 0) === 0 ? 0.08 : 0));


        // Tooltip
        //const tooltip = d3.select("#tooltip");
        
        //node.on("mouseover", function(event, d) {
        //   tooltip.transition().duration(200).style("opacity", .9);
        //  tooltip.html(`<strong>${d.label || d.id}</strong><br/>Type: ${d.type}<br/>Importance: ${d.importance || 'N/A'}`)
        //        .style("left", (event.pageX + 10) + "px")
        //        .style("top", (event.pageY - 28) + "px");
        //})
        //.on("mouseout", function() {
        //    tooltip.transition().duration(500).style("opacity", 0);
        //});
        
        // Update positions on simulation tick
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
            
            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
            
            label
                .attr("x", d => d.x)
                .attr("y", d => d.y)
                .attr("dy", d => -(nodeRadius(d) + 3)); // keep label above node as it moves
        });
        
        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Enable zoom after elements (esp. labels) exist
        svg.call(zoom);
    </script>
</body>
</html>